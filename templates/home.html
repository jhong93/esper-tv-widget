<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.3.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@3.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@4.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.15.0/umd/popper.min.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.9/css/bootstrap-select.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.9/js/bootstrap-select.min.js"></script>

  <link href="https://fonts.googleapis.com/css?family=Source+Serif+Pro" rel="stylesheet">

  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="{{ url_for('static', filename='js/chart.js') }}" /></script>
  <script src="{{ url_for('static', filename='js/query.js') }}" /></script>
  <script src="{{ url_for('static', filename='js/default.js') }}" /></script>

  <title>Stanford TV News Viewer</title>
  <style>
    #search-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0px 4px;
    }
    #search-table th {
      text-align: center;
    }
    #search-table input[name=query] {
      width: 100%;
      height: 30px;
      text-align: center;
      font-size: 14px;
      margin: auto;
    }
    #search-table .color-box {
      margin: auto;
      width: 40px;
      min-height: 30px;
    }
    #search-table .remove-row-btn {
      width: 35px;
      height: 30px;
      text-align: center;
      font-size: 14px;
    }
    #add-row-btn {
      width: 35px;
      height: 30px;
      text-align: center;
      font-size: 14px;
    }
    #chart-options {
      text-align: center;
      font-size: 14px;
    }
    #chart-options input, select, .filter-option {
      text-align: center;
      font-size: 14px;
    }
    #chart-options .datepicker {
      width: 100px;
    }
    #search {
      font-size: 14px;
    }
    #query-help {
      padding: 10px;
      background-color: #F4F4F4;
      border-spacing: 5px;
      display: none;
    }
    #query-help table {
      width: 100%;
      border-spacing: 2px;
      table-layout: auto;
    }
    #query-help th {
      text-align: left;
    }
    #query-help td, th {
      text-align: left;
      padding-left: 10px;
      padding-right: 10px;
    }
    #query-help tr:nth-child(odd) {
      background-color: #DAD7CB;
    }
    #query-help tr:nth-child(even) {
      background-color: #F9F6EF;
    }
    #embed-area textarea {
      width: 100%;
      margin: auto;
      display: none;
    }
    #chart {
      width: 100%;
      text-align: center;
    }
    #shade {
      background-color: #000000;
      display: none;
      opacity: 0.2;
      height: 100%;
      width: 100%;
      position:fixed;
      top: 0px;
      right: 0px;
      bottom:0px;
      left:0px;
    }
    .query-builder {
      padding: 10px;
    }
    .query-builder table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 2px;
    }
    .query-builder input {
      text-align: center;
    }
    .query-builder th {
      text-align: right;
    }
    .query-builder td[type=key-col] {
      text-align: right;
    }
    .query-builder td[type=value-col] {
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="top-header">
    <div class="container">
      <img src="{{ url_for('static', filename='stanford.png') }}"
           alt="Stanford University"><p>TV News Viewer</p>
    </div>
  </div>
  <div class="container">
    <form action="javascript:void(0);" onsubmit="search();">
      <table id="search-table">
        <tr class="header">
          <th></th>
          <th>Color</th>
          <th width="95%">Query
            (click color box for options or <a href="#" onclick="toggleQueryHelp(); return false;" id="toggle-help">show help</a>)
          </th>
        </tr>
        <tr name="controls" id="chart-options">
          <td>
            <button type="button" class="btn btn-outline-secondary btn-sm" id='add-row-btn'>+</button>
          </td>
          <td>&nbsp;</td>
          <td>
            Count
            <select class="selectpicker" id="countVar" data-width="fit">
              <option value="mentions">mentions</option>
              <option value="facetime" selected="selected">face time</option>
              <option value="videotime">video time</option>
            </select>
            between
            <input type="text" class="datepicker" id="startDate">
            and
            <input type="text" class="datepicker" id="endDate">
            aggregated by
            <select class="selectpicker" id="aggregateBy" data-width="fit">
              <option value="year">year</option>
              <option value="month" selected="selected">month</option>
              <option value="week">week</option>
              <option value="day">day</option>
            </select>
            . &nbsp;
            <input type="submit" class="btn btn-primary btn-sm" value="Search the news!">
          </td>
        </tr>
      </table>
    </form>
  </div>

  <script>
    function fromDatepickerStr(s) {
      let tokens = s.split('/');
      return `${tokens[2]}-${tokens[0]}-${tokens[1]}`
    }

    function toDatepickerStr(s) {
      let tokens = s.split('-');
      return `${tokens[1]}/${tokens[2]}/${tokens[0]}`
    }

    function getChartOptions() {
      let start_date = fromDatepickerStr($('#startDate').val());
      let end_date = fromDatepickerStr($('#endDate').val());
      if (start_date > end_date) {
        alertAndThrow('Start date cannot exceed end date.');
      }
      return {
        start_date: start_date,
        end_date: end_date,
        count: $('#countVar').val(),
        aggregate: $('#aggregateBy').val()
      }
    }

    function initChartOptions(chart_options) {
      var start_date = '{{ start_date }}';
      var end_date = '{{ end_date }}';
      if (chart_options) {
        start_date = chart_options.start_date;
        end_date = chart_options.end_date;
        $('#countVar').val(chart_options.count);
        $('#aggregateBy').val(chart_options.aggregate);
      }
      $('#startDate').datepicker({
        format: 'mm/dd/yyyy',
        forceParse: false,
        startDate: toDatepickerStr(start_date),
        endDate: toDatepickerStr(end_date)
      });
      $('#startDate').val(toDatepickerStr(start_date));
      $('#endDate').datepicker({
        format: 'mm/dd/yyyy',
        forceParse: false,
        startDate: toDatepickerStr(start_date),
        endDate: toDatepickerStr(end_date)
      });
      $('#endDate').val(toDatepickerStr(end_date));
    }
  </script>

  <div class="container" id="query-help">
    <p><b>Query help <a href="#" onclick="toggleQueryHelp(); return false;" id="toggle-help">(hide)</a></b>
      - The following options are supported (separated by <b>AND</b>).
    </p>

    <div class="container">
      <h4>Examples</h4>
      <table>
        <tr>
          <th>Counting</th>
          <th>Query</th>
          <th>English meaning</th>
        </tr>
        <tr>
          <td>mentions</td>
          <td>affordable care act WHERE channel="CNN" AND onscreen.person="Barack Obama"</td>
          <td><i>mentions of "affordable care act" on CNN when Barack Obama's face is on screen</i></td>
        </tr>
        <tr>
          <td>face&nbsp;time</td>
          <td>
            female hosts WHERE channel="FOX" <br>
            Barack Obama WHERE channel="FOX"
          </td>
          <td>
            <i>face time of female hosts on FOX News</i> <br>
            <i>face time of Barack Obama on FOX News</i>
          </td>
        </tr>
        <tr>
          <td>video&nbsp;time</td>
          <td>onscreen.face="women" AND caption.text="science"</td>
          <td><i>seconds of video where a female host is onscreen and the word "science" is mentioned</i></td>
        </tr>
      </table>
    </div>

    <div class="container">
      <h4>Countable</h4>
      <table>
        <tr>
          <th>Mode</th>
          <th>Description</th>
          <th>Values</th>
          <th>Default</th>
          <th>Example</th>
        </tr>
        <tr>
          <td>mentions</td>
          <td>phrase mentions in the captions</td>
          <td><a href="https://github.com/scanner-research/caption-index/blob/master/captions/query.py" target="_blank">grammar</a></td>
          <td>n/a</td>
          <td>affordable care act</td>
        </tr>
        <tr>
          <td>face&nbsp;time</td>
          <td>screen time for faces (height &ge; 20%)</td>
          <td>
            all, (wo)men, (non)hosts, (fe)male (non)hosts, <br>
            name of person <a href="/people" target="_blank">(list of people)</a>
          </td>
          <td>all</td>
          <td>female hosts<br>Barack Obama</td>
        </tr>
        <tr>
          <td>video&nbsp;time</td>
          <td>number of seconds of video</td>
          <td colspan="3"></td>
        </tr>
      </table>
    </div>

    <div class="container">
      <h4>Supported filters</h4>
      <table>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Values</th>
          <th>Default</th>
          <th>Example</th>
        </tr>
        <tr>
          <td>channel</td>
          <td>name of the channel</td>
          <td>CNN, FOX, MSNBC</td>
          <td>all</td>
          <td>channel=CNN</td>
        </tr>
        <tr>
          <td>show</td>
          <td>name of the show</td>
          <td><a href="/shows" target="_blank">list of shows</a></td>
          <td>all</td>
          <td>show="CNN Newsroom"</td>
        </tr>
        <tr>
          <td>hour</td>
          <td>ranges of hours in 24h format</td>
          <td>0-23 or 0, 1, 2, ...</td>
          <td>0-23</td>
          <td>hour="9-17"</td>
        </tr>
        <tr>
          <td>dayofweek</td>
          <td>range or list of days of the week</td>
          <td>mon-sun or mon, tue, ...</td>
          <td>all</td>
          <td>dayofweek="sat-sun"</td>
        </tr>
        <tr>
          <td>iscommercial</td>
          <td>filter or select commercials</td>
          <td>true, false, both</td>
          <td>{{ default_is_commercial }}</td>
          <td>iscommercial={{ default_is_commercial }}</td>
        </tr>
        <tr>
          <td>caption.text</td>
          <td>keywords nearby in the captions</td>
          <td>text query</td>
          <td>n/a</td>
          <td>caption.text="affordable care act"</td>
        </tr>
        <tr>
          <td>caption.window</td>
          <td>threshold (in seconds) for nearby keywords</td>
          <td>non-negative integer</td>
          <td>{{ default_text_window }}</td>
          <td>caption.window={{ default_text_window }}</td>
        </tr>
        <tr>
          <td>onscreen.face</td>
          <td>
            at least one matching face on screen (height &ge; 20%)</td>
          <td>
            all, (wo)men, (non)hosts, <br>
            (fe)male (non)hosts, <br>
            name of person <a href="/people" target="_blank">(list of people)</a>
          </td>
          <td>n/a</td>
          <td>
            onscreen.face="male hosts" <br>
            onscreen.face="Barack Obama"
          </td>
        </tr>
      </table>
    </div>

    <div class="container">
      <h4>Normalization and subtraction</h4>
      <table>
        <tr>
          <th>Keyword</th>
          <th>Syntax</th>
          <th>Description</th>
          <th>Example</th>
        </tr>
        <tr>
          <td>NORMALIZE</td>
          <td>query1 NORMALIZE query2</td>
          <td><i>divide query1's results by query2's results</i></td>
          <td>"united states" NORMALIZE</td>
        </tr>
        <tr>
          <td>SUBTRACT</td>
          <td>query1 SUBTRACT query2</td>
          <td><i>subtract query2's results from query1's results</i></td>
          <td>"united" SUBTRACT "united states"</td>
        </tr>
      </table>
    </div>
  </div>
  <script>
    function toggleQueryHelp() {
      if ($('#toggle-help').text().includes('show')) {
        $('#query-help').show();
        $('#toggle-help').text('hide help');
      } else {
        $('#query-help').hide();
        $('#toggle-help').text('show help');
      }
    }
  </script>

  <div class="container" id="chart-area">
    <div id="chart"></div>
  </div>

  <div class="container" id="embed-area">
    <p name="text"></p>
    <textarea readonly rows="3" name="embed"></textarea>
  </div>

  <div class="container" id="vgrid"></div>

  <div id="shade">&nbsp;</div>

  <script>
    const EMBED_DIMS = {width: 1000, height: 400};

    const ALL_SHOWS = [
      {% for show in shows %}"{{ show }}",{% endfor %}
    ];

    function getRandomSample(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getColor() {
      for (var i in DEFAULT_COLORS) {
        if ($(`#search-table tr[data-color='${DEFAULT_COLORS[i]}']`).length == 0) {
          return DEFAULT_COLORS[i];
        }
      }
      throw Error('All colors used');
    }

    function setRemoveButtonsState() {
      let state = $('#search-table tr[name="query"]').length < 2;
      $('#search-table td').find('button.remove-row-btn').each(function() {
        this.disabled = state;
      });
    }

    function removeRow(color) {
      $(`#search-table tr[data-color="${color}"]`).remove();
      $('#add-row-btn').prop('disabled', false);
      setRemoveButtonsState();
    }

    function getDefaultQuery() {
      let count_var = $('#countVar').val();
      if (count_var.includes('mentions')) {
        return DEFAULT_MENTIONS_QUERY;
      } else if (count_var.includes('facetime')) {
        return DEFAULT_FACETIME_QUERY;
      } else if (count_var.includes('videotime')) {
        return DEFAULT_VIDEOTIME_QUERY;
      }
    }

    function toggleQueryBuilder(color) {
      let search_table_row = $(`#search-table tr[data-color="${color}"]`);
      if (search_table_row.find('.query-builder').length > 0) {
        search_table_row.find('.query-builder').remove();
        search_table_row.find('.color-box').height('auto');
      } else {
        let builder_html = `
          <div class="query-builder">
            <table>
              <tr>
                <th style="text-align: right;">Include results where:</th>
                <th></th>
              </tr>
              <tr>
                <td type="key-col">the channel is</td>
                <td type="value-col">
                  <select class="selectpicker" name="channel" data-width="fit">
                    <option value="" selected="selected">CNN, FOX, or MSNBC</option>
                    <option value="CNN">CNN</option>
                    <option value="FOX">FOX</option>
                    <option value="MSNBC">MSNBC</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td type="key-col">the show is</td>
                <td type="value-col">
                  <select class="selectpicker" name="show" data-width="fit">
                    <option value="" selected="selected"></option>
                    {% for show in shows %}
                    <option value="{{ show }}">{{ show }}</option>
                    {% endfor %}
                  </select>
                </td>
              </tr>
              <tr>
                <td type="key-col">the hour of day is between</td>
                <td type="value-col"><input type="text" class="no-enter-submit" name="hour" value="" placeholder="0-23"></td>
              </tr>
              <tr>
                <td type="key-col">the day of week is</td>
                <td type="value-col"><input type="text" class="no-enter-submit" name="dayofweek" value="" placeholder="mon-fri"></td>
              </tr>
              <tr>
                <td type="key-col">
                  the captions contain
                </td>
                <td type="value-col">
                  <input type="text" class="no-enter-submit" name="caption.text" value="" placeholder="keyword or phrase">
                  within
                  <input type="number" class="no-enter-submit" name="caption.window" min="0" max="3600" placeholder="{{ default_text_window }}"> seconds
                </td>
              </tr>
              <tr>
                <td type="key-col">an on-screen face matches</td>
                <td type="value-col">
                  <select class="selectpicker" name="face.gender" data-width="fit">
                    <option value="" selected="selected"></option>
                    <option value="male">male</option>
                    <option value="female">female</option>
                  </select>
                  <select class="selectpicker" name="face.role" data-width="fit">
                    <option value="" selected="selected"></option>
                    <option value="host">host</option>
                    <option value="non-host">non-host</option>
                  </select>
                  or person
                  <select class="selectpicker" name="face.person" data-width="fit">
                    <option value="" selected="selected"></option>
                    <option value="donald trump">Donald Trump</option>
                    <option value="donald trump">Hillary Clinton</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td type="key-col">is in commercial</td>
                <td type="value-col">
                  <select class="selectpicker" name="iscommercial" data-width="fit">
                    <option value="false" selected="selected">false</option>
                    <option value="true">true</option>
                    <option value="both">both</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td></td>
                <td>
                  <button type="button" class="btn btn-outline-danger btn-sm" onclick="populateQueryBox('${color}');">populate query</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleQueryBuilder('${color}');">cancel</button>
                </td>
              </tr>
            </table>
          </div>`;
        search_table_row.find('td:last').append(builder_html);
        $('.selectpicker').selectpicker();

        // Set the color-box to be the height of the query box
        search_table_row.find('.color-box').height(
          search_table_row.find('td').height()
        );
      }
    }
    $('.no-enter-submit').keypress(e => e.which != 13);

    function populateQueryBox(color) {
      let search_table_row = $(`#search-table tr[data-color="${color}"]`);
      let builder = search_table_row.find('.query-builder');
      let filters = [];
      let channel = builder.find('select[name="channel"]').val();
      if (channel) {
        filters.push(`channel=${channel}`);
      }
      let show = builder.find('select[name="show"]').val();
      if (show) {
        filters.push(`show="${show}"`);
      }
      let hour = builder.find('input[name="hour"]').val();
      if (hour) {
        filters.push(`hour=${hour}`);
      }
      let dayofweek = builder.find('input[name="dayofweek"]').val();
      if (dayofweek) {
        filters.push(`dayofweek="${dayofweek}"`);
      }
      let caption_text = builder.find('input[name="caption.text"]').val();
      if (caption_text) {
        filters.push(`caption.text="${caption_text}"`);
      }
      let caption_window = builder.find('input[name="caption.window"]').val();
      if (caption_window) {
        filters.push(`caption.window=${caption_window}`);
      }
      let face_gender = builder.find('select[name="face.gender"]').val();
      let face_role = builder.find('select[name="face.role"]').val();
      let face_person = builder.find('select[name="face.person"]').val();
      if (face_person || face_role || face_gender) {
        var face_str;
        if (face_person) {
          if (face_role || face_gender) {
            alertAndThrow('"gender and role" cannot be specified simultaneously with "person"');
          }
          face_str = face_person;
        } else {
          face_str = `${face_gender ? face_gender + ' ' : ''}${face_role}`
        }
        filters.push(`onscreen.face=${face_str}`);
      }
      let is_commercial = builder.find('select[name="iscommercial"]').val();
      if (is_commercial != 'false') {
        filters.push(`iscommercial=${is_commercial}`);
      }

      let query_box = search_table_row.find('input[name="query"]');
      var current_query = query_box.val();
      if (current_query.includes('WHERE')) {
        current_query = current_query.slice(0, current_query.indexOf('WHERE'));
      }
      query_box.val(
        $.trim(current_query)
        + (filters.length > 0 ? ' WHERE ' + filters.join(' AND ') : ''));
      toggleQueryBuilder(color);
    }

    function addRow(query) {
      let color = query ? query.color : getColor();
      let text = query ? query.text : getDefaultQuery();
      let html = `<tr name="query" data-color="${color}">
        <td><button type="button" class="btn btn-outline-secondary btn-sm remove-row-btn" onclick="removeRow('${color}');">-</button></td>
        <td><div class="color-box" style="background-color: ${color};" onclick="javascript:toggleQueryBuilder('${color}');return false;"></div></td>
        <td><input type="text" name="query" value='${text}'></td>
      </tr>`;

      $('#search-table > tbody > tr').eq(
        $('#search-table tr[name="query"]').length
      ).after(html);
      if ($('#search-table tr[name="query"]').length >= DEFAULT_COLORS.length + 1) {
        $('#add-row-btn').prop('disabled', true);
      }
      setRemoveButtonsState();
    }
    $('#add-row-btn').click(() => {addRow();});

    function getDataString(chart_options, lines) {
      return encodeURIComponent(JSON.stringify({
        options: chart_options,
        queries: lines.map(l => ({color: l.color, text: l.query.query}))
      }));
    }

    function getEmbedUrl(data) {
      return `http://{{ host }}/embed?width=${EMBED_DIMS.width}&height=${EMBED_DIMS.height}&data=${data}`;
    }

    function getChartPath(data) {
      return `/?data=${data}`;
    }

    function setShareUrl(path) {
      var dummy = document.createElement('input');
      document.body.appendChild(dummy);
      dummy.setAttribute('value', 'http://{{ host }}' + path);
      dummy.select();
      document.execCommand("copy");
      document.body.removeChild(dummy);
      alert('Copied link to clipboard!');
    }

    function setEmbedUrl(url) {
      let x = $('#embed-area textarea[name="embed"]');
      x.val(`<iframe src="${url}"></iframe>`);
      x.toggle();
    }

    function alertAndThrow(msg) {
      alert(msg);
      throw Error(msg);
    }

    function displaySearchResults(chart_options, lines, search_results) {
      new Chart(chart_options, search_results, {
        width: $("#chart-area").width(), height: EMBED_DIMS.height
      }).load('#chart', '#vgrid');

      if (Object.keys(search_results).length == lines.length) {
        // Allow embedding if all queries are ok
        let data_str = getDataString(chart_options, lines);
        let chart_path = getChartPath(data_str);
        let embed_url = getEmbedUrl(data_str);
        $('#embed-area p[name="text"]').html(
          `<a href="#" onclick="setShareUrl('${chart_path}'); return false;">Share</a> or <a href="#" onclick="setEmbedUrl('${embed_url}'); return false;">embed</a> chart.`
        );
        window.history.pushState(null, '', chart_path);
      } else {
        // Allow embedding if all queries are ok
        $('#embed-area p[name="text"]').empty();
        window.history.pushState(null, '', '')
      }
    }

    function getRawQueries() {
      let queries = [];
      $('#search-table tr[name="query"]').each(function() {
        if ($(this).attr('name')) {
          let query_str = $.trim($(this).find("input[name='query']").val());
          queries.push({
            color: $(this).attr('data-color'),
            text: query_str
          });
        }
      });
      return queries;
    }

    function reset() {
      $('#vgrid').empty();
    }

    function search() {
      reset()

      let chart_options = getChartOptions();
      let lines = getRawQueries().map(raw_query => {
        var parsed_query;
        try {
          parsed_query = new SearchableQuery(raw_query.text, chart_options.count);
        } catch (e) {
          alertAndThrow(e.message);
        }
        return {color: raw_query.color, query: parsed_query};
      });

      $('#shade').show();
      $('#search').prop('disabled', true);

      let search_results = {};
      function onDone() {
        $('#shade').hide();
        $('#search').prop('disabled', false);
        displaySearchResults(chart_options, lines, search_results);
      }

      Promise.all(lines.map(line => {
        console.log('Executing query:', line.query);

        function onError(xhr) {
          var msg;
          try {
            msg = JSON.parse(xhr.responseText).message;
          } catch {
            msg = 'Unknown server error';
          }
          alert(`[Query failed] ${line.query.query}\n\n${msg}\n\nThe chart may be incomplete.`);

          console.log('Failed:', line.query, xhr);
        }

        return line.query.search(
          chart_options,
          result => search_results[line.color] = result,
          onError);
      })).then(onDone).catch(onDone);
    }

    /* Load initial plot */
    let params = (new URL(document.location)).searchParams;
    if (params.get('data')) {
      let data = JSON.parse(decodeURIComponent(params.get('data')));
      try {
        data.queries.forEach(query => addRow(query));
        initChartOptions(data.options);
        search();
      } catch (e) {
        alert('Invalid data in url. Unable to load.');
        console.log('Unable to load:', e);
      }
    } else {
      initChartOptions();
      addRow();
    }
  </script>
</body>
</html>
