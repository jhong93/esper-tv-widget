<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.3.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@3.0.0-rc15"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@4.0.0-rc1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.15.0/umd/popper.min.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.3/daterangepicker.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.3/daterangepicker.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.9/css/bootstrap-select.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.9/js/bootstrap-select.min.js"></script>

  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
  <script src="{{ url_for('static', filename='chart.js') }}" /></script>

  <title>Esper: TV News Search</title>
  <style>
    .container {
      padding: 10px;
    }
    .search-table-container table {
      border-spacing: 0px;
    }
    .search-table-container th {
      text-align: center;
    }
    .search-table-container input[name=query] {
      width: 600px;
      height: 40px;
      text-align: center;
      margin: auto;
    }
    .search-table-container input[name=filters] {
      width: 400px;
      height: 40px;
      text-align: center;
      margin: auto;
    }
    .color-box {
      margin: auto;
      width: 40px;
      height: 40px;
    }
    #filters-help {
      padding: 10px;
      background-color: #F4F4F4;
    }
    #filters-help th {
      text-align: center;
    }
    #filters-help td, th {
      text-align: left;
      padding-left: 10px;
      padding-right: 10px;
    }
    #chart-options input, select {
      text-align: center;
    }
    #embed-string {
      word-wrap: break-word;
    }
    #embed-string textarea {
      width: 100%;
      margin: auto;
    }
  </style>
</head>
<body>
  <div class="container search-table-container">
    <table id="search-table">
      <tr>
        <th>Color</th>
        <th>Keyword Query <a href="https://github.com/scanner-research/caption-index/blob/master/captions/query.py" target="_blank">(grammar)</a></th>
        <th>Filters (show help: <input type="checkbox" id="showFiltersHelp" onclick="showFiltersHelp()">)</th>
      </tr>
    </table>
  </div>

  <div class="container" id="chart-options">
    <button type="button" class="btn btn-secondary" id='addRow'>+</button>
    <button type="button" class="btn btn-secondary" id='removeRow'>-</button>
    &nbsp; Plot results between
    <input type="text" id="dateRange" />
    &nbsp; aggregated by
    <select class="selectpicker" id="aggregateBy" data-width="fit">
      <option value="year">year</option>
      <option value="month" selected="selected">month</option>
      <option value="week">week</option>
      <option value="day">day</option>
    </select>
    . &nbsp;
    <button type="button" class="btn btn-primary" id='search'>Search the news!</button>
  </div>
  <script>

    function getChartOptions() {
      return {
        start_date: $('#dateRange').data('daterangepicker').startDate._d.toISOString().split('T')[0],
        end_date: $('#dateRange').data('daterangepicker').endDate._d.toISOString().split('T')[0],
        aggregate: $('#aggregateBy').val(),
        window: 0
      }
    }
    function initChartOptions(chart_options) {
      var start_date = '{{ start_date }}';
      var end_date = '{{ end_date }}';
      if (chart_options) {
        start_date = chart_options.start_date;
        end_date = chart_options.end_date;
        $('#aggregateBy').val(chart_options.aggregate);
        $('#window').val(chart_options.window);
      }
      $(function() {
        $('#dateRange').daterangepicker({
          opens: 'right',
          startDate: moment(start_date, 'YYYY-MM-DD'),
          endDate: moment(end_date, 'YYYY-MM-DD')
        });
      });
    }
  </script>

  <div class="container" id="filters-help">
    <p><b>Filters usage</b> - The following filters are supported (separated by ';'s).</p>
    <div class="container">
      <table>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Values</th>
          <th>Default</th>
          <th>Example</th>
        </tr>
        <tr>
          <td>channel</td>
          <td>name of the channel</td>
          <td>CNN, FOXNEWS, MSNBC</td>
          <td></td>
          <td>channel: CNN</td>
        </tr>
        <tr>
          <td>show</td>
          <td>name of the show</td>
          <td><a href="/shows" target="_blank">list of shows</a></td>
          <td></td>
          <td>show: CNN Newsroom</td>
        </tr>
        <tr>
          <td>hours</td>
          <td>ranges of hours in 24h format</td>
          <td>0-23 or 0, 1, 2, ...</td>
          <td>0-23</td>
          <td>hours: 9-17</td>
        </tr>
        <tr>
          <td>weekdays</td>
          <td>ranges of days; 1=Mon, 7=Sun</td>
          <td>1-7 or 1, 2, ...</td>
          <td>1-7</td>
          <td>weekdays: 6-7</td>
        </tr>
      </table>
    </div>
  </div>
  <script>
    function showFiltersHelp() {
      if ($('#showFiltersHelp').is(':checked')) {
        $("#filters-help").show();
      } else {
        $("#filters-help").hide();
      }
    }
    showFiltersHelp();
  </script>

  <div class="container">
    <div id="chart"></div>
    <div id="embed-string"></div>
  </div>

  <script>
    const CHART_DIMS = {width: 1000, height: 400};

    const COLORS = [
      'red', 'blue', 'green',  'orange', 'cyan', 'magenta',
      'purple', 'yellow', 'gray', 'brown'
    ];

    const DEFAULT_QUERIES = [
        'donald trump',
        'hillary clinton',
        'terrorism',
        'isis',
        'immigration',
        'black lives | blacklivesmatter | blacklives',
        'brexit',
        'obamacare | affordable care act',
        'irs | internal revenue service',
        'socialism | socialist',
        'hurricane irma', 'fifa',
        'facebook',
        'alternative facts | fake news',
        'collusion',
        'sean spicer & [resign]',
        'global warming',
        'arab spring',
        '787 | dreamliner',
        'trayvon martin',
        'north korea | dprk',
        'bernie sanders',
        'nafta',
        'e coli | ecoli',
        'ebola',
        'border wall | border fence',
        'government shutdown'
    ];

    function getRandomSample(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getColor() {
      for (var i in COLORS) {
        if ($(`#search-table tr[name='${COLORS[i]}']`).length == 0)
          return COLORS[i];
      }
      throw 'All colors used';
    }

    function addRow(query) {
      let color = query ? query.color : getColor();
      let query_str = query ? query.query : getRandomSample(DEFAULT_QUERIES);
      let filters_str = query ? query.filters : '';
      let html = `<tr name='${color}'>
        <td><div class="color-box" style="background-color: ${color};"></div></td>
        <td><input type="text" name="query" value="${query_str}"</td>
        <td><input type="text" name="filters" value="${filters_str}" placeholder='channel: none; show: none'></td>
      </tr>`;
      $('#search-table tbody').append(html);
    }
    $('#addRow').click(() => {addRow();});

    function removeRow() {
      if ($('#search-table tr').length > 2) {
        $('#search-table tr:last').remove();
      }
    }
    $('#removeRow').click(removeRow);

    function getEmbedUrl(chart_options, queries) {
      return `http://{{ host }}/embed?width=${CHART_DIMS.width}&height=${CHART_DIMS.height}&data=${btoa(JSON.stringify({options: chart_options, queries: queries}))}`;
    }

    function getShareUrl(chart_options, queries) {
      return `http://{{ host }}/?data=${btoa(JSON.stringify({options: chart_options, queries: queries}))}`;
    }

    function setEmbedString(share_url, embed_url) {
      if (embed_url && share_url) {
        $('#embed-string').html(
          `<p><b><a href="${share_url}" target="_blank">Share</a> or embed this chart:</b> <textarea readonly rows="3"><iframe src="${embed_url}"></iframe></textarea></p>`
        );
      } else {
        $('#embed-string').clear();
      }
    }

    function search() {
      let chart_options = getChartOptions();
      let queries = [];
      $('#search-table tr').each(function() {
        if ($(this).attr('name')) {
          let query_str = $.trim($(this).find("input[name='query']").val());
          let query_filters_str = $.trim($(this).find("input[name='filters']").val());
          if (query_str) {
            queries.push({
              color: $(this).attr('name'),
              query: query_str,
              filters: query_filters_str
            });
          }
        }
      });

      function displayResults() {
        loadChart('#chart', chart_options, search_results, CHART_DIMS);
        let embed_url = getEmbedUrl(chart_options, queries);
        let share_url = getShareUrl(chart_options, queries);
        setEmbedString(share_url, embed_url);
      }

      let search_results = {};
      var remaining = queries.length;
      queries.forEach(query => {
        var args = {query: query.query};
        args = Object.assign(
          args, getQueryOptions(chart_options, parseFilters(query.filters))
        );
        $.ajax({
          url: '/search',
          type: 'get',
          data: args,
          success: resp => {
            search_results[query.color] = {
              query: query.query,
              data: resp
            };
            remaining--;
            if (remaining <= 0) {
              displayResults();
            }
          },
          error: xhr => {
            alert('Query failed. The chart may be incomplete.');
            console.log('Failed:', query);
            remaining--;
            if (remaining <= 0) {
              displayResults();
            }
          }
        });
      });
    }
    $('#search').click(search);

    /* Load initial plot */
    let params = (new URL(document.location)).searchParams;
    if (params.get('data')) {
      let data = JSON.parse(atob(params.get('data')));
      try {
        data.queries.forEach(query => addRow(query));
        initChartOptions(data.options);
        // TODO: something about datepicker takes time to initialize
        setTimeout(search, 100);
      } catch (e) {
        alert('Invalid data in url. Unable to load.');
        console.log('Unable to load:', e);
      }
    } else {
      initChartOptions();
      addRow();
    }
  </script>

  <script>
    $('textarea').each(function () {
      this.setAttribute('style', 'height:' + (this.scrollHeight) + 'px;overflow-y:hidden;');
    }).on('input', function () {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  </script>
</body>
</html>
