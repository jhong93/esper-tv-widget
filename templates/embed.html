<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.3.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@3.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@4.0.0"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
  <script src="{{ url_for('static', filename='default.js') }}" /></script>
  <script src="{{ url_for('static', filename='chart.js') }}" /></script>
  <script src="{{ url_for('static', filename='query.js') }}" /></script>

  <title>Stanford TV News Viewer</title>
  <style>
    .container {
      padding: 2px;
      text-align: center;
    }
    .container table {
      margin: auto;
      width: auto;
      border-spacing: 0px;
    }
    .container th, td {
      text-align: center;
      padding-left: 10px;
      padding-right: 10px;
    }
    .color-box {
      margin: auto;
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <table id="search-table">
      <tr>
        <th>Color</th>
        <th>Query</th>
      </tr>
    </table>
  </div>
  <div class="container" id="options"></div>
  <div class="container">
    <div id="chart"></div>
  </div>

  <script>
    const ALL_SHOWS = [
      {% for show in shows %}"{{ show }}",{% endfor %}
    ];

    let params = (new URL(document.location)).searchParams;
    let data = JSON.parse(decodeURIComponent(params.get('data')));
    let width = params.get('width');
    let height = params.get('height');
    let unparsed_queries = data.queries;
    let chart_options = data.options;

    function renderText() {
      // TODO: XSS attack here
      unparsed_queries.forEach(query => {
        let html = `<tr name='${query.color}'>
          <td><div class="color-box" style="background-color: ${query.color};"></div></td>
          <td>${query.query}</td>
        </tr>`;
        $('#search-table tbody').append(html);
      });
      $('#options').html(`Showing ${chart_options.count} from <b>${chart_options.start_date}</b> to <b>${chart_options.end_date}</b> aggregated by <b>${chart_options.aggregate}</b>.`);
    }

    let parsed_queries = unparsed_queries.map(query => {
      var filters;
      try {
        filters = parseQueryString(query.query);
      } catch (e) {
        alertAndThrow(e.message);
      }
      return {
        color: query.color, query: query.query,
        main_args: getQueryOptions(chart_options, filters.main_query),
        // Set subquery args
        minus_args: filters.minus_query ?
          getQueryOptions(chart_options, filters.minus_query) : null,
        norm_args: filters.norm_query ?
          getQueryOptions(chart_options, filters.norm_query) : null
      };
    });

    function searchOne(data, onSuccess, onError) {
      return $.ajax({
        url: '/search', type: 'get', data: data, success: onSuccess,
        error: onError
      });
    }

    let search_results = {};
    function onDone() {
      loadChart('#chart', chart_options, search_results,
                {width: width, height: height});
      renderText();
    };

    Promise.all(parsed_queries.flatMap(query => {
      console.log('Executing query:', query);
      search_results[query.color] = {query: query.query, is_bad: false};

      function onError(xhr) {
        var msg;
        try {
          msg = JSON.parse(xhr.responseText).message;
        } catch {
          msg = 'Unknown server error';
        }
        alert(`[Query failed. The chart may be incomplete.]\n\n${msg}`);
        console.log('Failed:', query);
        search_results[query.color].is_bad = true;
      }

      let promises = [];
      promises.push(searchOne(
        Object.assign({detailed: true}, query.main_args), (resp) => {
          search_results[query.color].data = resp;
        }, onError));
      if (query.norm_args) {
        promises.push(searchOne(
          Object.assign({detailed: false}, query.norm_args), (resp) => {
            search_results[query.color].norm_data = resp;
          }, onError));
      }
      if (query.minus_args) {
        promises.push(searchOne(
          Object.assign({detailed: false}, query.minus_args), (resp) => {
            search_results[query.color].minus_data = resp;
          }, onError));
      }
      return promises;
    })).then(onDone).catch(onDone)
    ;
  </script>
</body>
</html>
