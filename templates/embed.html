<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.3.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@3.0.0-rc15"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@4.0.0-rc1"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
  <script src="{{ url_for('static', filename='chart.js') }}" /></script>

  <title>Esper: Embeded Chart</title>
  <style>
    .container {
      padding: 2px;
      text-align: center;
    }
    .container table {
      margin: auto;
      width: auto;
      border-spacing: 0px;
    }
    .container th, td {
      text-align: center;
      padding-left: 10px;
      padding-right: 10px;
    }
    .color-box {
      margin: auto;
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <table id="search-table">
      <tr>
        <th>Color</th>
        <th>Keyword Query <a href="https://github.com/scanner-research/caption-index/blob/master/captions/query.py" target="_blank">(grammar)</a></th>
        <th>Filters</th>
      </tr>
    </table>
  </div>
  <div class="container" id="options"></div>
  <div class="container">
    <div id="chart"></div>
  </div>

  <script>
    let params = (new URL(document.location)).searchParams;
    let data = JSON.parse(atob(params.get("data")));
    let width = params.get("width");
    let height = params.get("height");
    let queries = data.queries;
    let chart_options = data.options;

    function renderText() {
      // TODO: XSS attack here
      queries.forEach(query => {
        let html = `<tr name='${query.color}'>
          <td><div class="color-box" style="background-color: ${query.color};"></div></td>
          <td>${query.query}</td>
          <td>${query.filters ? query.filters : 'none'}</td>
        </tr>`;
        $('#search-table tbody').append(html);
      });
      $('#options').html(`Showing results from <b>${chart_options.start_date}</b> to <b>${chart_options.end_date}</b> aggregated by <b>${chart_options.aggregate}</b>.`);
    }

    let search_results = {};
    var remaining = queries.length;
    queries.forEach(query => {
      var args = {query: query.query};
      args = Object.assign(
        args, getQueryOptions(chart_options, parseFilters(query.filters))
      );
      function displayResults() {
        loadChart('#chart', chart_options, search_results, {width: width, height: height});
        renderText();
      };
      $.ajax({
        url: '/search',
        type: 'get',
        data: args,
        success: resp => {
          search_results[query.color] = {
            query: query.query,
            data: resp
          };
          remaining--;
          if (remaining <= 0) {
            displayResults();
          }
        },
        error: xhr => {
          alert('Query failed. The chart may be incomplete.');
          console.log('Failed:', query);
          remaining--;
          if (remaining <= 0) {
            displayResults();
          }
        }
      });
    });
  </script>
</body>
</html>
